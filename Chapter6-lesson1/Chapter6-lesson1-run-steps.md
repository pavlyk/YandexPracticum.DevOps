### 0. Script generating dummy data for PostgreSQL

`vi insert-data.sh`  

```bash
#!/bin/bash

PSQL_ADMIN=sudmedru
PSQL_PASSWORD=$PSQL_PASSWORD
PSQL_HOST=6432
PSQL_PORT='rc1b-rkh2fcafeufkyuw2.mdb.yandexcloud.net'
PSQL_DBNAME=sudmedru
export PSQL_CONNECTION="postgresql://$PSQL_ADMIN:$PSQL_PASSWORD@$PSQL_HOST:$PSQL_PORT/$PSQL_DBNAME"

touch init.sql

echo "drop table product;" >> init.sql
echo "drop table orders;" >> init.sql
echo "drop table order_product;" >> init.sql

echo "create table product(id bigint generated by default as identity, name varchar(255) not null, picture_url varchar(255), price double precision);" >> init.sql

echo "insert into product (id, name, picture_url, price) values (1, 'Сливочная', 'https://res.cloudinary.com/sugrobov/image/upload/v1623323635/repos/sausages/6.jpg', 320.00);" >> init.sql
echo "insert into product (id, name, picture_url, price) values (2, 'Особая', 'https://res.cloudinary.com/sugrobov/image/upload/v1623323635/repos/sausages/5.jpg', 179.00);" >> init.sql
echo "insert into product (id, name, picture_url, price) values (3, 'Молочная', 'https://res.cloudinary.com/sugrobov/image/upload/v1623323635/repos/sausages/4.jpg', 225.00);" >> init.sql
echo "insert into product (id, name, picture_url, price) values (4, 'Нюренбергская', 'https://res.cloudinary.com/sugrobov/image/upload/v1623323635/repos/sausages/3.jpg', 315.00);" >> init.sql
echo "insert into product (id, name, picture_url, price) values (5, 'Мюнхенская', 'https://res.cloudinary.com/sugrobov/image/upload/v1623323635/repos/sausages/2.jpg', 330.00);" >> init.sql
echo "insert into product (id, name, picture_url, price) values (6, 'Русская', 'https://res.cloudinary.com/sugrobov/image/upload/v1623323635/repos/sausages/1.jpg', 189.00);" >> init.sql

echo "create table orders(id bigint generated by default as identity, status varchar(255), date_created date default current_date);" >> init.sql
echo "create table order_product(quantity integer not null, order_id bigint not null, product_id bigint not null);" >> init.sql

echo "insert into orders (id, status) select i, left(md5(random()::text), 4) from generate_series(1, 10000000) s(i);" >> init.sql
echo "insert into order_product (quantity, order_id, product_id) select floor(1+random()*50)::int, i, 1 + floor(random()*6)::int % 6 from generate_series(1, 10000000) s(i);" >> init.sql

psql $PSQL_CONNECTION -f init.sql

rm -f init.sql
```


### 1. Login via psql
```bash
psql postgresql://my_email:password@rc1b-rkh2fcafeufkyuw2.mdb.yandexcloud.net:6432/my_email
```

```sql
 \dt
             List of relations
 Schema |     Name      | Type  |  Owner
--------+---------------+-------+----------
 public | order_product | table | sudmedru
 public | orders        | table | sudmedru
 public | product       | table | sudmedru
(3 rows)
```

### 2. Add db connection parameters for start .jar in unit file
```console
--spring.datasource.url=jdbc:postgresql://rc1b-rkh2fcafeufkyuw2.mdb.yandexcloud.net:6432/my_email
--spring.datasource.username=my_email
--spring.datasource.password=password
```

```console
[Unit]
Description=Sausage Store Backend Service
After=syslog.target

[Service]
Type=simple
WorkingDirectory=/home/jarservice/
ExecStart=/usr/bin/java -jar /home/jarservice/sausage-store.jar --server.port=8888 --spring.datasource.url=jdbc:postgresql://rc1b-rkh2fcafeufkyuw2.mdb.yandexcloud.net:6432/my_email --spring.datasource.username=my_email --spring.datasource.password=password
User=jarservice
Restart=always
RestartSec=5s
StartLimitBurst=5
Environment="REPORT_PATH=/var/www-data/htdocs"
Environment="LOG_PATH=/var/jarservice/"
#Environment=REPORT_PATH=/log/reports
#Environment=LOG_PATH=/log
#StandardOutput=file:/log/out.log
SuccessExitStatus=143

[Install]
WantedBy=multi-user.target
```


### 3. Update postgresql-client from 12 to 14
```bash
sudo apt-get remove -y postgresql-client
sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt/ `lsb_release -cs`-pgdg main" >> /etc/apt/sources.list.d/pgdg.list'
wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
sudo apt-get update
sudo apt-get install -y postgresql-client-14
```


### 4. Create db dump in 8 threads, in directory format
```sql
pg_dump postgresql://my_email:password@rc1b-rkh2fcafeufkyuw2.mdb.yandexcloud.net:6432/my_email -j 8 -Fd -f /tmp/dump.dir
```

#### 4.1. Restore db dump
```sql
pg_restore -d "postgresql://my_email:password@rc1b-rkh2fcafeufkyuw2.mdb.yandexcloud.net:6432/my_email" --format=d /tmp/dump.dir/
```


### 5. Create indexes
```sql
CREATE INDEX index_name ON table_name [USING method] (column_name);
```

#### 5.1. Names of columns to be indexed:
1. Table "product"  
    * id
    * name  
    * price  
    
2. Table "order_product"
    * order_id
    * product_id

3.  Table "orders"
    * id


### 5.2. Set timing on and get db query execution time before indexes creation
```sql
\timing on
```

```sql
select COUNT(*) from orders o INNER JOIN order_product op ON o.id = op.order_id INNER JOIN product p ON op.product_id = p.id WHERE p.id = 4;
```
```console
  count
---------- 
 13344440
(1 row)
Time: 18527.650 ms (00:18.528)
```

------------------------------------------------------------

### 5.3. Create indexes for `order_product` table
```sql
CREATE INDEX idx_order_product_id ON order_product (order_id);
```

```sql
CREATE INDEX idx_order_product_product_id ON order_product (product_id);
```

#### Describe table and check indexes
```sql
\d order_product
             Table "public.order_product"
   Column   |  Type   | Collation | Nullable | Default
------------+---------+-----------+----------+---------
 quantity   | integer |           | not null |
 order_id   | bigint  |           | not null |
 product_id | bigint  |           | not null |
Indexes:
    "idx_order_product_id" btree (order_id)
    "idx_order_product_product_id" btree (product_id)
```
------------------------------------------------------------
### 5.4. Create index for `orders` table
```sql
CREATE INDEX idx_orders_id ON orders (id);
```

#### Describe table and check index
```sql
\d orders
                                      Table "public.orders"
    Column    |          Type          | Collation | Nullable |             Default
--------------+------------------------+-----------+----------+----------------------------------
 id           | bigint                 |           | not null | generated by default as identity
 status       | character varying(255) |           |          |
 date_created | date                   |           |          | CURRENT_DATE
Indexes:
    "idx_orders_id" btree (id)
```

------------------------------------------------------------

### 5.5. Create indexes for `product` table
```sql
CREATE INDEX idx_product_id ON product (id);
```
```sql
CREATE INDEX idx_product_name ON product (name);
```
```sql
CREATE INDEX idx_product_price ON product (price);
```

#### Describe table and check indexes
```sql
\d product
                                     Table "public.product"
   Column    |          Type          | Collation | Nullable |             Default
-------------+------------------------+-----------+----------+----------------------------------
 id          | bigint                 |           | not null | generated by default as identity
 name        | character varying(255) |           | not null |
 picture_url | character varying(255) |           |          |
 price       | double precision       |           |          |
Indexes:
    "idx_product_id" btree (id)
    "idx_product_name" btree (name)
    "idx_product_price" btree (price)
```

------------------------------------------------------------

### 6. Check db query execution time after indexes creation
```sql
select COUNT(*) from orders o INNER JOIN order_product op ON o.id = op.order_id INNER JOIN product p ON op.product_id = p.id WHERE p.id = 4;
  count
----------
 13344440
(1 row)

Time: 10956.501 ms (00:10.957)
```


```sql
EXPLAIN ANALYSE select COUNT(*) from orders o INNER JOIN order_product op ON o.id = op.order_id INNER JOIN product p ON op.product_id = p.id WHERE p.id = 4;
                                                                                              QUERY PLAN
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Finalize Aggregate  (cost=843598.69..843598.70 rows=1 width=8) (actual time=17726.307..17726.404 rows=1 loops=1)
   ->  Gather  (cost=843598.47..843598.68 rows=2 width=8) (actual time=17726.296..17726.399 rows=3 loops=1)
         Workers Planned: 2
         Workers Launched: 2
         ->  Partial Aggregate  (cost=842598.47..842598.48 rows=1 width=8) (actual time=17364.540..17364.545 rows=1 loops=3)
               ->  Hash Join  (cost=378539.87..828917.03 rows=5472579 width=0) (actual time=3589.629..17166.894 rows=4448147 loops=3)
                     Hash Cond: (o.id = op.order_id)
                     ->  Parallel Seq Scan on orders o  (cost=0.00..210722.35 rows=8333335 width=8) (actual time=0.014..699.399 rows=6666668 loops=3)
                     ->  Hash  (cost=269033.49..269033.49 rows=6674670 width=8) (actual time=3587.619..3587.621 rows=6672216 loops=3)
                           Buckets: 131072  Batches: 128  Memory Usage: 3074kB
                           ->  Nested Loop  (cost=0.44..269033.49 rows=6674670 width=8) (actual time=0.068..2255.116 rows=6672216 loops=3)
                                 ->  Index Scan using idx_order_product_product_id on order_product op  (cost=0.44..185598.96 rows=3337335 width=16) (actual time=0.051..842.380 rows=3336108 loops=3)
                                       Index Cond: (product_id = 4)
                                 ->  Materialize  (cost=0.00..1.16 rows=2 width=8) (actual time=0.000..0.000 rows=2 loops=10008324)
                                       ->  Seq Scan on product p  (cost=0.00..1.15 rows=2 width=8) (actual time=0.013..0.014 rows=2 loops=3)
                                             Filter: (id = 4)
                                             Rows Removed by Filter: 10
 Planning Time: 0.433 ms
 Execution Time: 10726.476 ms
(19 rows)

Time: 10731.773 ms (00:10.732)
```
