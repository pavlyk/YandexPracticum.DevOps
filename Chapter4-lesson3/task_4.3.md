# Глава 4. Практическая работа 3

Выполните откат на предыдущую версию с помощью заложенных в GitLab механизмов. Можете ориентироваться на [GitLab environment rollback](https://docs.gitlab.com/ee/ci/environments/#environment-rollback).  


#### **Что такое environment в GitLab**  
В GitLab есть возможность создавать разные `environments` для `Job`.  
`Environment` описывает целевое окружение, на которое будет выполняться развёртывание приложения. С помощью таких окружений, можно, например, делать **rollback**.  
Описываются окружения ключевым словом `environment` в `.gitlab-ci.yml` (внутри `job`):  
```yaml
environment:
    name: $CI_COMMIT_REF_SLUG
    on_stop: Delete deploy 
```
`CI_COMMIT_REF_SLUG` — имя ветки или тега с парой модификаций: имя в нижнем регистре и все символы, отличные от `0-9`, `a-z` заменены на `-`.  
`CI_COMMIT_REF_SLUG` часто используется, чтобы во время выполнения `job` получать имя ветки.  
`environment:on_stop:` имя `job` — помогает динамически создавать и удалять окружение.  
**Пример 1**
Например, есть `job` для деплоя приложения и описанный ранее `environment`:  
1. Создаём ветку `feature`  
2. На основе ветки делаем MR  
3. Запускается task  
4. Работаем с MR  
5. Сливаем MR в `master` (или закрываем его)  
6. Автоматически выполнится task из `on_stop`  
7. Ненужное окружение удалится.  
**Однако**: это сработает, если нажать кнопку в GitLab, но при использовании локального `git merge` task автоматически не запустится.  
**Пример 2**
```yaml
environment:
    name: staging
    url: https://sausage-store-stage.ru/ 
```
`environment:url` — в разделе `environment` рядом с деплойментом появится кнопка `Open` с указанной ссылкой. Это удобно для быстрой проверки приложения после выкатки.  


#### **Как посмотреть и что делать с environment**  
Чтобы посмотреть, какие имеются окружения, нужно зайти на страницу проекта. Далее `Deployments > Environments` и увидим список доступных окружений.  
Если `environment` описан, как в **примере 1**, то увидим имена веток или теги.  
Если использовался **пример 2**, то увидим заданное имя окружения: `staging`.  


#### **Как откатить environment (сделать rollback)**
Для этого нужно:
* Нажать кнопку `Re-deploy` to environment рядом с деплойментом (см. три вертикальных точки)
* Просто выкатить деплоймент ещё раз (нажать кнопку `play`)  
При **rollback** будет создан новый деплоймент со своим уникальным ID. Он будет указывать на коммит, на который откатываемся.  
