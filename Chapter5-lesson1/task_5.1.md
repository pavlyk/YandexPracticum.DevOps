# Глава 5. Практическая работа 1

Запустим сосисочную, чтобы логи записывались в нужную нам папку и ротировались. Затем вам понадобится сделать бекап для вашей виртуальной машины, а потом использовать бекап диска для новой виртуальной машины, которая станет «бекапочной».  

1. Создайте проект `infrastructure`, а в нём папку `backup`. Добавьте в проект ветку `backup`.  
2. Запустите сосисочную из файла `sausage-store-0.0.1-SNAPSHOT.jar`, который лежит в домашнем каталоге, и записывайте логи в `/opt/log/sausage-store.log`. Напомним, что вы изучали развёртывание нашего приложения в уроке 3 главы 4, когда запускали пайплайн. По желанию, можете даже собрать пайплайн вручную.  
3. С помощью `logrotate` настройте ротацию логов для сосисочной по принципу: размер лога не больше 10 мегабайт, правило проверяется раз в час, прошлые версии архивируются и их должно быть не больше 3. Не забудьте сделать так, чтобы при срабатывании настроенного в ротации правила в файл `/opt/student_rotate.log` отправлялось время отработки вашего правила **logrotate**. Сохранте конфиг от logrotate в ваш новый репозиторий в папку `backup` с именем `logrotate_config`.
4. Зайдите в Яндекс.Облако по [ссылке](https://console.cloud.yandex.ru/federations/bpfpfctkh7focc85u9sq). Авторизуйтесь под аккаунтом из самой первой рассылки со всеми доступами. В качестве логина используйте логин в Яндекс.Облако, пароль можете взять по соседству.
5. Убедитесь, что вы вошли в облако `cloud-praktikumdevopscourse`. Если вы не видите данного облака в списке, напишите куратору. Обращаем ваше внимание, что дальнейшие задания нужно выполнять в этом облаке.  
6. Создайте образ диска вашей виртуальной машины и назовите его `<имя-фамилия-день-месяц-backup>`.  
7. Восстановите из вашего образа новую виртуалку с именем `<имя-фамилия-день-месяц-backup>`.
8. Сделайте эту виртуальную машину прерываемой — проставьте галочку в соответствующем чекбоксе. Убедитесь, что на новой виртуальной машине, развёрнутой из образа, сосисочная не запущена.
9. Создайте пользователей `user-backup` на обеих виртуальных машинах с правами: на первой машине — с доступом к бэкенду сосисочной на чтение, на второй — с правами за запись в папку `/opt/backup`.
10. Настройте **rsync** для бэкапирования раз в час файла бэкенда сосисочной на вторую машину в папку `/opt/backup/<год-месяц-день-час>/`. Запуск задания от пользователя **user-backup** поместите в конец файла `/etc/crontab` первой машины. Сохраните с 1-й виртуалки изменённый файл `/etc/crontab` в ваш репозиторий, в папку backup под именем `crontab_rsync`.
11. Настройте на 2-й виртуалке ротацию бэкапов бэкендов, добавив в `/etc/crontab` строчку на удаление старых файлов (см. урок). Нужно, чтобы их было не больше 30. Сохраните со 2-й виртуалки изменённый файл `/etc/crontab` в ваш проект, в папку `backup` под именем `crontab_rotate`.
12. Передайте наставнику IP-адреса ваших виртуальных машин. Создайте Merge Request в ветку main (или master) и отправьте наставнику ссылку с MR на проверку.
13. После того как задание будет принято, удалите вторую виртуальную машину и на первой машине в `cron` остановите запуск **rsync**.
